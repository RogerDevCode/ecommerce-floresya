<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Compra - FloresYa</title>

    <!-- Tailwind CSS - Single source -->
    <link rel="stylesheet" href="/css/styles.css">

    <!-- SEO -->
    <meta name="description" content="Finaliza tu compra en FloresYa - Métodos de pago seguros">
    <meta property="og:title" content="Checkout - FloresYa">
    <meta property="og:description" content="Completa tu pedido de flores">
    <meta property="og:type" content="website">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@0.451.0/dist/umd/lucide.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Loading State -->
    <div id="loading" class="fixed inset-0 bg-white z-50 flex items-center justify-center hidden">
        <div class="text-center">
            <div class="animate-spin w-8 h-8 border-4 border-pink-500 border-t-transparent rounded-full mx-auto mb-4"></div>
            <p class="text-gray-600">Procesando pago...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button id="backBtn" class="flex items-center space-x-2 text-gray-600 hover:text-pink-600 transition-colors">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        <span>Volver al carrito</span>
                    </button>
                </div>
                <h1 class="text-xl font-bold text-pink-600">🌸 FloresYa</h1>
                <div class="flex items-center space-x-3">
                    <div class="flex items-center space-x-2 text-sm text-gray-500">
                        <i data-lucide="shield-check" class="w-4 h-4"></i>
                        <span>Compra segura</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Indicator -->
    <div class="bg-white border-b">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-center space-x-4">
                <div class="flex items-center text-pink-600">
                    <div class="w-8 h-8 bg-pink-600 text-white rounded-full flex items-center justify-center text-sm font-semibold">
                        1
                    </div>
                    <span class="ml-2 text-sm font-medium">Carrito</span>
                </div>
                <div class="h-px bg-pink-600 w-8"></div>
                <div class="flex items-center text-pink-600">
                    <div class="w-8 h-8 bg-pink-600 text-white rounded-full flex items-center justify-center text-sm font-semibold">
                        2
                    </div>
                    <span class="ml-2 text-sm font-medium">Pago</span>
                </div>
                <div class="h-px bg-gray-300 w-8"></div>
                <div class="flex items-center text-gray-400">
                    <div class="w-8 h-8 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center text-sm font-semibold">
                        3
                    </div>
                    <span class="ml-2 text-sm font-medium">Confirmación</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6 max-w-6xl">
        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Payment Form -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Customer Information -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i data-lucide="user" class="w-5 h-5 mr-2"></i>
                        Información de Contacto
                    </h3>

                    <form id="customerForm" class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                                <input type="text" id="firstName" name="firstName" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                            </div>
                            <div>
                                <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">Apellido</label>
                                <input type="text" id="lastName" name="lastName" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                            </div>
                        </div>

                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label>
                            <input type="email" id="email" name="email" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                        </div>

                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                            <input type="tel" id="phone" name="phone" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                                   placeholder="+58 414 123 4567">
                        </div>

                        <div>
                            <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Dirección de Entrega</label>
                            <textarea id="address" name="address" rows="2" required
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                                      placeholder="Ingresa la dirección completa para la entrega"></textarea>
                        </div>
                    </form>
                </div>

                <!-- Payment Methods -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i data-lucide="credit-card" class="w-5 h-5 mr-2"></i>
                        Métodos de Pago
                    </h3>

                    <div class="space-y-3">
                        <!-- Bank Transfer -->
                        <div class="payment-method border border-gray-200 rounded-lg p-4 cursor-pointer hover:border-pink-500 transition-colors" data-method="transfer">
                            <div class="flex items-center">
                                <input type="radio" id="transfer" name="paymentMethod" value="transfer" class="text-pink-600 focus:ring-pink-500">
                                <label for="transfer" class="ml-3 flex-1 cursor-pointer">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <i data-lucide="building-2" class="w-5 h-5 text-gray-500 mr-2"></i>
                                            <div>
                                                <div class="font-medium text-gray-900">Transferencia Bancaria</div>
                                                <div class="text-sm text-gray-500">Banesco, Mercantil, Venezuela</div>
                                            </div>
                                        </div>
                                        <div class="text-sm text-green-600 font-medium">Recomendado</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Mobile Payment -->
                        <div class="payment-method border border-gray-200 rounded-lg p-4 cursor-pointer hover:border-pink-500 transition-colors" data-method="mobile">
                            <div class="flex items-center">
                                <input type="radio" id="mobile" name="paymentMethod" value="mobile" class="text-pink-600 focus:ring-pink-500">
                                <label for="mobile" class="ml-3 flex-1 cursor-pointer">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <i data-lucide="smartphone" class="w-5 h-5 text-gray-500 mr-2"></i>
                                            <div>
                                                <div class="font-medium text-gray-900">Pago Móvil</div>
                                                <div class="text-sm text-gray-500">C.I: 12.345.678 - Teléfono: 0414-1234567</div>
                                            </div>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Zelle -->
                        <div class="payment-method border border-gray-200 rounded-lg p-4 cursor-pointer hover:border-pink-500 transition-colors" data-method="zelle">
                            <div class="flex items-center">
                                <input type="radio" id="zelle" name="paymentMethod" value="zelle" class="text-pink-600 focus:ring-pink-500">
                                <label for="zelle" class="ml-3 flex-1 cursor-pointer">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <i data-lucide="dollar-sign" class="w-5 h-5 text-gray-500 mr-2"></i>
                                            <div>
                                                <div class="font-medium text-gray-900">Zelle</div>
                                                <div class="text-sm text-gray-500">floresya@gmail.com</div>
                                            </div>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Details Form -->
                    <div id="paymentDetails" class="mt-6 hidden">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-medium text-gray-900 mb-3">Datos del Pago</h4>

                            <div class="space-y-4">
                                <div>
                                    <label for="referenceNumber" class="block text-sm font-medium text-gray-700 mb-1">Número de Referencia</label>
                                    <input type="text" id="referenceNumber" name="referenceNumber" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500"
                                           placeholder="Ingresa el número de referencia del pago">
                                </div>

                                <div>
                                    <label for="paymentAmount" class="block text-sm font-medium text-gray-700 mb-1">Monto Pagado</label>
                                    <input type="text" id="paymentAmount" name="paymentAmount" required readonly
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                                </div>

                                <div>
                                    <label for="paymentDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha del Pago</label>
                                    <input type="date" id="paymentDate" name="paymentDate" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-sm p-6 sticky top-24">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Resumen del Pedido</h3>

                    <!-- Order Items -->
                    <div id="orderItems" class="space-y-3 mb-6">
                        <!-- Items will be populated by JavaScript -->
                    </div>

                    <!-- Currency Converter -->
                    <div class="border-t pt-4 mb-6">
                        <h4 class="font-medium text-gray-900 mb-3">Conversión de Moneda</h4>

                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Subtotal USD:</span>
                                <span id="subtotalUSD" class="font-medium">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Envío:</span>
                                <span class="font-medium">$5.00</span>
                            </div>
                            <div class="flex justify-between font-semibold border-t pt-2">
                                <span>Total USD:</span>
                                <span id="totalUSD" class="text-pink-600">$0.00</span>
                            </div>
                        </div>

                        <div class="mt-4 p-3 bg-pink-50 rounded-lg">
                            <div class="text-center">
                                <div class="text-sm text-gray-600 mb-1">Total en Bolívares</div>
                                <div id="totalBs" class="text-xl font-bold text-pink-600">Bs 0.00</div>
                                <div class="text-xs text-gray-500 mt-1">Tasa BCV: <span id="bcvRate">Bs 36.50</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Button -->
                    <button id="completeOrderBtn" class="w-full bg-pink-600 text-white py-4 rounded-lg font-semibold hover:bg-pink-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed">
                        Completar Pedido
                    </button>

                    <!-- Security Note -->
                    <div class="mt-4 text-center">
                        <div class="flex items-center justify-center space-x-2 text-sm text-gray-500">
                            <i data-lucide="shield-check" class="w-4 h-4"></i>
                            <span>Tus datos están protegidos</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full p-6 text-center">
            <div class="text-green-500 mb-4">
                <i data-lucide="check-circle" class="w-16 h-16 mx-auto"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">¡Pedido Confirmado!</h3>
            <p class="text-gray-600 mb-4">Tu pedido ha sido registrado exitosamente. Te contactaremos pronto para confirmar los detalles.</p>
            <div class="bg-gray-50 p-3 rounded-lg mb-4">
                <div class="text-sm text-gray-600">Número de Pedido</div>
                <div id="orderNumber" class="font-semibold text-lg">#FY-001</div>
            </div>
            <button id="goHomeBtn" class="bg-pink-600 text-white px-6 py-2 rounded-lg hover:bg-pink-700 transition-colors">
                Volver al Inicio
            </button>
        </div>
    </div>

    <script type="module">
        // === PAYMENT CONTROLLER ===
        class PaymentController {
            constructor() {
                this.cart = JSON.parse(localStorage.getItem('floresyaCart') || '[]');
                this.selectedPaymentMethod = null;
                this.bcvRate = 36.50; // Default BCV rate

                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadOrderSummary();
                this.updateCurrency();
                this.initializeLucideIcons();
            }

            setupEventListeners() {
                // Back button
                document.getElementById('backBtn').addEventListener('click', () => {
                    window.location.href = '/pages/cart.html';
                });

                // Payment method selection
                document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        this.selectPaymentMethod(e.target.value);
                    });
                });

                // Complete order
                document.getElementById('completeOrderBtn').addEventListener('click', () => {
                    this.completeOrder();
                });

                // Go home button
                document.getElementById('goHomeBtn').addEventListener('click', () => {
                    window.location.href = '/';
                });

                // Set today's date as default
                document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            }

            selectPaymentMethod(method) {
                this.selectedPaymentMethod = method;

                // Update payment details
                const paymentDetails = document.getElementById('paymentDetails');
                const paymentAmount = document.getElementById('paymentAmount');

                if (method === 'zelle') {
                    paymentAmount.value = document.getElementById('totalUSD').textContent;
                } else {
                    paymentAmount.value = document.getElementById('totalBs').textContent;
                }

                paymentDetails.classList.remove('hidden');
                this.updateCompleteButton();
            }

            loadOrderSummary() {
                const orderItemsContainer = document.getElementById('orderItems');

                if (this.cart.length === 0) {
                    orderItemsContainer.innerHTML = '<p class="text-gray-500 text-center">No hay productos en el carrito</p>';
                    return;
                }

                orderItemsContainer.innerHTML = this.cart.map(item => `
                    <div class="flex items-center space-x-3">
                        <img src="${item.image || '/images/placeholder-product.webp'}"
                             alt="${item.name}"
                             class="w-12 h-12 object-cover rounded">
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium text-gray-900 truncate">${item.name}</div>
                            <div class="text-sm text-gray-500">Cantidad: ${item.quantity}</div>
                        </div>
                        <div class="text-sm font-medium text-gray-900">
                            ${this.formatPrice(item.price * item.quantity)}
                        </div>
                    </div>
                `).join('');
            }

            updateCurrency() {
                const subtotal = this.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const shipping = 5.00;
                const totalUSD = subtotal + shipping;
                const totalBs = totalUSD * this.bcvRate;

                document.getElementById('subtotalUSD').textContent = this.formatPrice(subtotal);
                document.getElementById('totalUSD').textContent = this.formatPrice(totalUSD);
                document.getElementById('totalBs').textContent = `Bs ${totalBs.toFixed(2)}`;
                document.getElementById('bcvRate').textContent = `Bs ${this.bcvRate}`;
            }

            async completeOrder() {
                if (!this.validateForm()) {
                    return;
                }

                // Show loading
                document.getElementById('loading').classList.remove('hidden');

                try {
                    // Simulate API call
                    await this.sleep(2000);

                    // Generate order number
                    const orderNumber = `FY-${Date.now().toString().slice(-6)}`;
                    document.getElementById('orderNumber').textContent = `#${orderNumber}`;

                    // Clear cart
                    localStorage.removeItem('floresyaCart');

                    // Show success modal
                    document.getElementById('successModal').classList.remove('hidden');

                } catch (error) {
                    alert('Error al procesar el pedido. Por favor intenta de nuevo.');
                } finally {
                    document.getElementById('loading').classList.add('hidden');
                }
            }

            validateForm() {
                const customerForm = document.getElementById('customerForm');
                const formData = new FormData(customerForm);

                // Check required fields
                const requiredFields = ['firstName', 'lastName', 'email', 'phone', 'address'];
                for (const field of requiredFields) {
                    if (!formData.get(field)) {
                        alert(`Por favor completa el campo: ${field}`);
                        return false;
                    }
                }

                // Check payment method
                if (!this.selectedPaymentMethod) {
                    alert('Por favor selecciona un método de pago');
                    return false;
                }

                // Check payment details
                const referenceNumber = document.getElementById('referenceNumber').value;
                if (!referenceNumber) {
                    alert('Por favor ingresa el número de referencia del pago');
                    return false;
                }

                return true;
            }

            updateCompleteButton() {
                const button = document.getElementById('completeOrderBtn');
                button.disabled = !this.selectedPaymentMethod || this.cart.length === 0;
            }

            formatPrice(price) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 2
                }).format(price);
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            initializeLucideIcons() {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Lucide icons
            if (window.lucide) {
                window.lucide.createIcons();
            }

            // Initialize controller
            new PaymentController();
        });
    </script>
</body>
</html>