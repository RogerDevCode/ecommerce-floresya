<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Im√°genes - FloresYa</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .image-test {
            display: flex;
            gap: 20px;
            margin: 15px 0;
            align-items: center;
        }
        .image-test img {
            width: 200px;
            height: 200px;
            object-fit: cover;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .image-info {
            flex: 1;
        }
        .url {
            word-break: break-all;
            font-family: monospace;
            background: #f0f0f0;
            padding: 5px;
            border-radius: 4px;
            font-size: 12px;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            margin: 5px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .loading { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>üêõ Debug de Im√°genes - FloresYa</h1>
    
    <div class="test-section">
        <h2>üìä Estado del Servidor</h2>
        <div id="server-status" class="loading">Verificando...</div>
    </div>

    <div class="test-section">
        <h2>üß™ Tests de Conectividad</h2>
        <div id="connectivity-tests"></div>
    </div>

    <div class="test-section">
        <h2>üñºÔ∏è Tests de Im√°genes</h2>
        <div id="image-tests"></div>
    </div>

    <script>
        console.log('üöÄ Iniciando debug de im√°genes...');

        // Test 1: Server Status
        async function testServerStatus() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                document.getElementById('server-status').innerHTML = `
                    <div class="status success">‚úÖ Servidor funcionando</div>
                    <p>Versi√≥n: ${data.version}</p>
                    <p>Timestamp: ${data.timestamp}</p>
                `;
            } catch (error) {
                document.getElementById('server-status').innerHTML = `
                    <div class="status error">‚ùå Error de servidor: ${error.message}</div>
                `;
            }
        }

        // Test 2: Connectivity Tests
        async function testConnectivity() {
            const tests = [
                {
                    name: 'API Products',
                    url: '/api/products?limit=1',
                    type: 'json'
                },
                {
                    name: 'Supabase Direct (CORS Test)',
                    url: 'https://dcbavpdlkcjdtjdkntde.supabase.co/storage/v1/object/public/product-images/large/arreglo-de-mesa-elegante-1-large.webp',
                    type: 'image'
                },
                {
                    name: 'Image Proxy',
                    url: '/api/images/proxy/large/arreglo-de-mesa-elegante-1-large.webp',
                    type: 'image'
                }
            ];

            const container = document.getElementById('connectivity-tests');
            
            for (const test of tests) {
                const testDiv = document.createElement('div');
                testDiv.innerHTML = `
                    <h4>${test.name}</h4>
                    <div class="url">${test.url}</div>
                    <div class="status loading" id="test-${test.name.replace(/\s/g, '')}">Probando...</div>
                `;
                container.appendChild(testDiv);

                try {
                    const response = await fetch(test.url, { 
                        method: test.type === 'image' ? 'HEAD' : 'GET'
                    });
                    
                    const statusEl = document.getElementById(`test-${test.name.replace(/\s/g, '')}`);
                    
                    if (response.ok) {
                        statusEl.className = 'status success';
                        statusEl.innerHTML = `‚úÖ OK (${response.status}) - ${response.headers.get('content-type')}`;
                    } else {
                        statusEl.className = 'status error';
                        statusEl.innerHTML = `‚ùå Error ${response.status} - ${response.statusText}`;
                    }
                } catch (error) {
                    const statusEl = document.getElementById(`test-${test.name.replace(/\s/g, '')}`);
                    statusEl.className = 'status error';
                    statusEl.innerHTML = `‚ùå Error: ${error.message}`;
                }
            }
        }

        // Test 3: Image Loading Tests
        async function testImageLoading() {
            try {
                const response = await fetch('/api/products?limit=3');
                const data = await response.json();
                
                if (!data.success) throw new Error('API Error');

                const container = document.getElementById('image-tests');
                
                for (const product of data.data.products) {
                    const productDiv = document.createElement('div');
                    productDiv.innerHTML = `
                        <h4>${product.name}</h4>
                        <div class="image-test">
                            <div>
                                <h5>Supabase Directo</h5>
                                <img id="direct-${product.id}" src="${product.image_url}" alt="${product.name}">
                                <div class="url">${product.image_url}</div>
                                <div class="status loading" id="status-direct-${product.id}">Cargando...</div>
                            </div>
                            <div>
                                <h5>Via Proxy</h5>
                                <img id="proxy-${product.id}" src="/api/images/direct/large/${product.image_url.split('/').pop()}" alt="${product.name}">
                                <div class="url">/api/images/direct/large/${product.image_url.split('/').pop()}</div>
                                <div class="status loading" id="status-proxy-${product.id}">Cargando...</div>
                            </div>
                        </div>
                    `;
                    container.appendChild(productDiv);

                    // Set up image load handlers
                    const directImg = document.getElementById(`direct-${product.id}`);
                    const proxyImg = document.getElementById(`proxy-${product.id}`);

                    directImg.onload = () => {
                        document.getElementById(`status-direct-${product.id}`).className = 'status success';
                        document.getElementById(`status-direct-${product.id}`).innerHTML = '‚úÖ Cargada correctamente';
                    };
                    
                    directImg.onerror = () => {
                        document.getElementById(`status-direct-${product.id}`).className = 'status error';
                        document.getElementById(`status-direct-${product.id}`).innerHTML = '‚ùå Error cargando imagen';
                    };

                    proxyImg.onload = () => {
                        document.getElementById(`status-proxy-${product.id}`).className = 'status success';
                        document.getElementById(`status-proxy-${product.id}`).innerHTML = '‚úÖ Cargada correctamente';
                    };
                    
                    proxyImg.onerror = () => {
                        document.getElementById(`status-proxy-${product.id}`).className = 'status error';
                        document.getElementById(`status-proxy-${product.id}`).innerHTML = '‚ùå Error cargando imagen';
                    };
                }

            } catch (error) {
                document.getElementById('image-tests').innerHTML = `
                    <div class="status error">‚ùå Error cargando productos: ${error.message}</div>
                `;
            }
        }

        // Run all tests
        async function runAllTests() {
            await testServerStatus();
            await testConnectivity();
            await testImageLoading();
        }

        // Start tests when page loads
        window.addEventListener('DOMContentLoaded', runAllTests);
    </script>
</body>
</html>