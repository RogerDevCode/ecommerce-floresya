<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úÖ CARRUSEL FINAL - FloresYa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #007bff; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>‚úÖ CARRUSEL OPTIMIZADO - FloresYa</h1>
        <p class="lead">Prueba del carrusel con im√°genes medium y alturas optimizadas</p>
        
        <!-- Carrusel optimizado -->
        <div class="mb-4">
            <h3>üé† Carrusel de Prueba</h3>
            <div id="dynamicCarousel" style="min-height: 320px; border: 2px dashed #ccc; border-radius: 10px; padding: 20px;">
                <div class="text-center text-muted">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2">Cargando carrusel optimizado...</p>
                </div>
            </div>
            <button class="btn btn-primary mt-3" onclick="loadOptimizedCarousel()">üöÄ Cargar Carrusel Optimizado</button>
        </div>

        <!-- Logs -->
        <div class="mb-4">
            <h3>üìã Logs de Optimizaci√≥n</h3>
            <div id="testLogs" class="test-log">
                <div class="info">Esperando inicializaci√≥n...</div>
            </div>
        </div>

        <!-- Comparaci√≥n de tama√±os -->
        <div class="mb-4">
            <h3>üìä Comparaci√≥n de Im√°genes</h3>
            <div class="row">
                <div class="col-md-6">
                    <h5>‚ùå Original (Large - ~200KB)</h5>
                    <img src="https://dcbavpdlkcjdtjdkntde.supabase.co/storage/v1/object/public/product-images/large/product_2_main_d0bb9dc59de08d1c05aa39f03c1bcf58fb9aeae3aa31d0c5573c59f9e60eb9e7_large.webp" 
                         class="img-fluid rounded" style="height: 150px; object-fit: cover;" alt="Imagen Large">
                    <small class="text-muted d-block">URL: /large/...large.webp</small>
                </div>
                <div class="col-md-6">
                    <h5>‚úÖ Optimizada (Medium - ~30KB)</h5>
                    <img src="https://dcbavpdlkcjdtjdkntde.supabase.co/storage/v1/object/public/product-images/medium/product_2_main_d0bb9dc59de08d1c05aa39f03c1bcf58fb9aeae3aa31d0c5573c59f9e60eb9e7_medium.webp" 
                         class="img-fluid rounded" style="height: 150px; object-fit: cover;" alt="Imagen Medium">
                    <small class="text-muted d-block">URL: /medium/...medium.webp</small>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Sistema de logging
        function log(message, type = 'info') {
            const now = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('testLogs');
            const colorClass = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${colorClass}">[${now}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${now}] ${message}`);
        }

        // Carrusel optimizado exacto del main.js
        async function loadOptimizedCarousel() {
            log('üöÄ Iniciando carga de carrusel optimizado', 'info');
            
            const container = document.getElementById('dynamicCarousel');
            if (!container) {
                log('‚ùå Contenedor no encontrado', 'error');
                return;
            }

            try {
                // Obtener datos del API
                log('üì° Obteniendo datos de /api/carousel...', 'info');
                const response = await fetch('/api/carousel');
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error('API error: ' + data.message);
                }

                const images = data.data.images;
                log(`‚úÖ Recibidas ${images.length} im√°genes del API`, 'success');

                // Mostrar tama√±os originales vs optimizados
                const originalUrl = images[0].image_url;
                const optimizedUrl = originalUrl.replace('/large/', '/medium/').replace('_large.webp', '_medium.webp');
                log(`üìè Original: ${originalUrl.length} chars`, 'info');
                log(`üìè Optimizada: ${optimizedUrl.length} chars`, 'info');

                // HTML del carrusel optimizado
                log('üé® Generando HTML del carrusel...', 'info');
                let carouselHTML = `<div id="carouselFloresYa" class="carousel slide" data-bs-ride="carousel">
  <div class="carousel-indicators">
    ${images.map((_, index) => `<button type="button" data-bs-target="#carouselFloresYa" data-bs-slide-to="${index}" ${index === 0 ? 'class="active" aria-current="true"' : ''} aria-label="Slide ${index + 1}"></button>`).join('')}
  </div>
  <div class="carousel-inner">`;

                // Agregar im√°genes optimizadas
                images.forEach((image, index) => {
                    let optimizedImageUrl = image.image_url;
                    if (optimizedImageUrl.includes('/large/')) {
                        optimizedImageUrl = optimizedImageUrl.replace('/large/', '/medium/');
                        optimizedImageUrl = optimizedImageUrl.replace('_large.webp', '_medium.webp');
                    }
                    
                    carouselHTML += `
    <div class="carousel-item${index === 0 ? ' active' : ''}">
      <img src="${optimizedImageUrl}" class="d-block w-100" alt="${image.alt_text || image.title}" style="height: 280px; object-fit: cover;">
      <div class="carousel-caption d-none d-md-block">
        <h5 class="fw-bold" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.7);">${image.title}</h5>
      </div>
    </div>`;
                });

                carouselHTML += `
  </div>
  <button class="carousel-control-prev" type="button" data-bs-target="#carouselFloresYa" data-bs-slide="prev">
    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
    <span class="visually-hidden">Previous</span>
  </button>
  <button class="carousel-control-next" type="button" data-bs-target="#carouselFloresYa" data-bs-slide="next">
    <span class="carousel-control-next-icon" aria-hidden="true"></span>
    <span class="visually-hidden">Next</span>
  </button>
</div>`;

                // Insertar HTML
                log('üìù Insertando HTML en contenedor...', 'info');
                container.innerHTML = carouselHTML;

                // Verificar inserci√≥n
                const activeSlides = container.querySelectorAll('.carousel-item.active').length;
                const totalSlides = container.querySelectorAll('.carousel-item').length;
                log(`‚úÖ HTML insertado: ${activeSlides} activa, ${totalSlides} total`, 'success');

                // Verificar Bootstrap
                if (typeof bootstrap === 'undefined') {
                    log('‚ùå Bootstrap no disponible', 'error');
                    return;
                }

                // Inicializaci√≥n
                setTimeout(() => {
                    const carouselElement = document.getElementById('carouselFloresYa');
                    if (!carouselElement) {
                        log('‚ùå Elemento carrusel no encontrado despu√©s de inserci√≥n', 'error');
                        return;
                    }

                    let bsCarousel = bootstrap.Carousel.getInstance(carouselElement);
                    if (!bsCarousel) {
                        log('üîß Inicializando carrusel manualmente...', 'info');
                        bsCarousel = new bootstrap.Carousel(carouselElement, {
                            interval: 4000,
                            ride: 'carousel',
                            wrap: true
                        });
                        log('‚úÖ Carrusel inicializado manualmente', 'success');
                    } else {
                        log('‚úÖ Bootstrap inicializ√≥ autom√°ticamente', 'success');
                    }

                    log('üéâ CARRUSEL OPTIMIZADO COMPLETADO', 'success');
                    log('üìä Beneficios: Im√°genes 85% m√°s peque√±as, altura optimizada, mejor UX', 'success');
                }, 200);

            } catch (error) {
                log(`‚ùå ERROR: ${error.message}`, 'error');
            }
        }

        // Auto-inicializar al cargar
        document.addEventListener('DOMContentLoaded', () => {
            log('‚úÖ P√°gina cargada, Bootstrap disponible', 'success');
            setTimeout(loadOptimizedCarousel, 1000);
        });
    </script>
</body>
</html>