<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Inline - FloresYa Database Browser</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <span class="text-primary fw-bold">üå∏ FloresYa Test</span>
            </a>
            
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="bi bi-house-fill"></i> Volver al Inicio
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container py-5">
        <div class="text-center mb-4">
            <h1 class="text-primary">
                <i class="bi bi-database-fill"></i>
                Test de Conexi√≥n FloresYa
            </h1>
            <p class="text-muted">Versi√≥n inline para debugging</p>
        </div>

        <!-- Status -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Estado</h5>
                    </div>
                    <div class="card-body" id="status">
                        <span class="text-success">‚úÖ P√°gina cargada</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <button type="button" class="btn btn-primary me-2" onclick="testBasicConnection()">
                    üîó Test Conexi√≥n B√°sica
                </button>
                <button type="button" class="btn btn-success me-2" onclick="testCategories()">
                    üìÇ Test Categor√≠as
                </button>
                <button type="button" class="btn btn-warning me-2" onclick="testProducts()">
                    üì¶ Test Productos
                </button>
                <button type="button" class="btn btn-info" onclick="testFilters()">
                    üîç Test Filtros
                </button>
            </div>
        </div>

        <!-- Results -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Resultados del Test</h5>
            </div>
            <div class="card-body">
                <div id="results">
                    <p class="text-muted">Haz clic en cualquier bot√≥n para ejecutar tests...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        console.log('üîç Test inline JavaScript loaded');

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            const colorClass = type === 'success' ? 'text-success' : 
                              type === 'error' ? 'text-danger' : 
                              type === 'warning' ? 'text-warning' : 'text-info';
            statusEl.innerHTML = `<span class="${colorClass}">‚óè ${message}</span>`;
        }

        function updateResults(html) {
            document.getElementById('results').innerHTML = html;
        }

        // Test basic connection
        async function testBasicConnection() {
            console.log('Testing basic connection...');
            updateStatus('Probando conexi√≥n b√°sica...', 'info');
            
            try {
                // First test basic health endpoint
                const response = await fetch('/api/health');
                const data = await response.json();
                
                console.log('Basic health response:', data);
                
                if (data.success) {
                    updateStatus('‚úÖ Conexi√≥n b√°sica exitosa', 'success');
                    updateResults(`
                        <div class="alert alert-success">
                            <h6>‚úÖ Conexi√≥n B√°sica Exitosa</h6>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `);
                } else {
                    throw new Error('Response not successful');
                }
                
            } catch (error) {
                console.error('Connection error:', error);
                updateStatus('‚ùå Error de conexi√≥n', 'error');
                updateResults(`
                    <div class="alert alert-danger">
                        <h6>‚ùå Error de Conexi√≥n</h6>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `);
            }
        }

        // Test categories endpoint
        async function testCategories() {
            console.log('Testing categories...');
            updateStatus('Probando endpoint de categor√≠as...', 'info');
            
            try {
                const response = await fetch('/api/test/categories');
                const data = await response.json();
                
                console.log('Categories response:', data);
                
                if (data.success) {
                    updateStatus(`‚úÖ ${data.data.categories.length} categor√≠as encontradas`, 'success');
                    
                    let html = `
                        <div class="alert alert-success">
                            <h6>‚úÖ Categor√≠as Cargadas (${data.data.categories.length})</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Total:</strong> ${data.data.summary.total_categories}</p>
                                    <p><strong>Activas:</strong> ${data.data.summary.active_categories}</p>
                                    <p><strong>Con productos:</strong> ${data.data.summary.categories_with_products}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6>Categor√≠as encontradas:</h6>
                                    <ul class="list-unstyled">
                    `;
                    
                    data.data.categories.forEach(cat => {
                        html += `<li>‚Ä¢ <strong>${cat.name}</strong> (ID: ${cat.id}) - ${cat.product_count} productos</li>`;
                    });
                    
                    html += `
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    updateResults(html);
                } else {
                    throw new Error(data.message || 'Unknown error');
                }
                
            } catch (error) {
                console.error('Categories error:', error);
                updateStatus('‚ùå Error cargando categor√≠as', 'error');
                updateResults(`
                    <div class="alert alert-danger">
                        <h6>‚ùå Error Cargando Categor√≠as</h6>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `);
            }
        }

        // Test products endpoint
        async function testProducts() {
            console.log('Testing products...');
            updateStatus('Probando endpoint de productos...', 'info');
            
            try {
                const response = await fetch('/api/test/products?limit=10');
                const data = await response.json();
                
                console.log('Products response:', data);
                
                if (data.success) {
                    updateStatus(`‚úÖ ${data.data.products.length} productos encontrados`, 'success');
                    
                    let html = `
                        <div class="alert alert-success">
                            <h6>‚úÖ Productos Cargados (${data.data.products.length})</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Total productos:</strong> ${data.data.summary.total_products}</p>
                                    <p><strong>Productos activos:</strong> ${data.data.summary.active_products}</p>
                                    <p><strong>Productos destacados:</strong> ${data.data.summary.featured_products}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6>Primeros productos:</h6>
                                    <ul class="list-unstyled">
                    `;
                    
                    data.data.products.slice(0, 5).forEach(prod => {
                        html += `<li>‚Ä¢ <strong>${prod.name}</strong> - $${prod.price}</li>`;
                    });
                    
                    html += `
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    if (data.data.stats) {
                        html += '<div class="mt-3"><h6>Estad√≠sticas por ocasi√≥n:</h6><div class="d-flex flex-wrap">';
                        data.data.stats.by_occasion.forEach(stat => {
                            html += `<span class="badge bg-secondary me-2 mb-1">${stat.occasion}: ${stat.count}</span>`;
                        });
                        html += '</div></div>';
                    }
                    
                    updateResults(html);
                } else {
                    throw new Error(data.message || 'Unknown error');
                }
                
            } catch (error) {
                console.error('Products error:', error);
                updateStatus('‚ùå Error cargando productos', 'error');
                updateResults(`
                    <div class="alert alert-danger">
                        <h6>‚ùå Error Cargando Productos</h6>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `);
            }
        }

        // Test filtered products
        async function testFilters() {
            console.log('Testing filters...');
            updateStatus('Probando filtros de productos...', 'info');
            
            try {
                // Test different filters
                const tests = [
                    { name: 'Ocasi√≥n: birthday', url: '/api/test/filtered-products?occasion=birthday&limit=5' },
                    { name: 'Ocasi√≥n: anniversary', url: '/api/test/filtered-products?occasion=anniversary&limit=5' },
                    { name: 'Solo destacados', url: '/api/test/filtered-products?featured=true&limit=10' },
                ];
                
                let html = '<div class="alert alert-info"><h6>üîç Resultados de Tests de Filtros</h6>';
                
                for (const test of tests) {
                    try {
                        const response = await fetch(test.url);
                        const data = await response.json();
                        
                        if (data.success) {
                            html += `
                                <div class="mt-3 p-3 border rounded">
                                    <h6>${test.name}</h6>
                                    <p>‚úÖ Encontrados: ${data.data.results.count} productos</p>
                            `;
                            
                            if (data.data.products.length > 0) {
                                html += '<ul>';
                                data.data.products.slice(0, 3).forEach(prod => {
                                    html += `<li>${prod.name} - $${prod.price} (${prod.occasion || 'General'})</li>`;
                                });
                                html += '</ul>';
                            }
                            
                            html += '</div>';
                        } else {
                            html += `<div class="mt-2 p-2 bg-light rounded"><strong>${test.name}:</strong> ‚ùå ${data.message}</div>`;
                        }
                    } catch (testError) {
                        html += `<div class="mt-2 p-2 bg-light rounded"><strong>${test.name}:</strong> ‚ùå ${testError.message}</div>`;
                    }
                }
                
                html += '</div>';
                updateStatus('‚úÖ Tests de filtros completados', 'success');
                updateResults(html);
                
            } catch (error) {
                console.error('Filters error:', error);
                updateStatus('‚ùå Error probando filtros', 'error');
                updateResults(`
                    <div class="alert alert-danger">
                        <h6>‚ùå Error Probando Filtros</h6>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, ready for tests');
            updateStatus('‚úÖ P√°gina lista para tests', 'success');
        });

        console.log('All functions defined successfully');
    </script>
</body>
</html>