<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Panel de Administraci贸n - FloresYa">
    <title>Panel de Administraci贸n - FloresYa</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/admin.css">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico">

    <style>
        /*  CRITICAL: Prevent FOUC - Loading overlay must be visible immediately */
        #loadingOverlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(255,255,255,0.9) !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            z-index: 9999 !important;
        }

        /* Admin Panel Styles */
        .admin-sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .admin-content {
            min-height: 100vh;
            background-color: #f8f9fa;
        }

        .sidebar-brand {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-brand h4 {
            color: white;
            margin: 0;
            font-weight: 700;
        }

        .sidebar-nav .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            margin: 0.25rem 1rem;
            transition: all 0.3s ease;
        }

        .sidebar-nav .nav-link:hover {
            color: white;
            background-color: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }

        .sidebar-nav .nav-link.active {
            color: white;
            background-color: rgba(255,105,180,0.8);
            box-shadow: 0 4px 15px rgba(255,105,180,0.3);
        }

        .sidebar-nav .nav-link i {
            width: 20px;
            margin-right: 10px;
        }

        .admin-header {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .admin-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .admin-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .metric-card.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .metric-card.warning {
            background: linear-gradient(135deg, #fcb045 0%, #fd1d1d 100%);
        }

        .metric-card.info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .table-responsive {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        }

        .btn-admin {
            border-radius: 8px;
            font-weight: 600;
            padding: 0.5rem 1.5rem;
            transition: all 0.3s ease;
        }

        .btn-admin:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-active {
            background-color: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .admin-sidebar {
                position: fixed;
                z-index: 1000;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .admin-sidebar.show {
                transform: translateX(0);
            }

            .admin-content {
                margin-left: 0;
            }
        }

        /*  FALLBACK MODE STYLES  */
        .fallback-mode {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }

        .fallback-alert {
            max-width: 800px;
            margin: 0 auto;
            border: 2px solid #ffc107;
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        }

        .fallback-alert .alert-heading {
            color: #856404;
            font-weight: 600;
        }

        .fallback-retry-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .fallback-retry-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
            background: linear-gradient(135deg, #218838 0%, #17a2b8 100%);
        }

        /* Emergency visibility styles */
        .emergency-visible {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Force show content even with CSS issues */
        .force-show {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            min-height: 400px;
        }

        /*  CRITICAL MODAL FIX  */
        .modal.show {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .modal.fade.show {
            opacity: 1 !important;
            visibility: visible !important;
            transition: none !important;
        }

        /* Force modal to be visible when it has the show class */
        #productModal.modal.show,
        #testBootstrapModal.modal.show {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 1055 !important;
        }

        /* Fix modal backdrop */
        .modal-backdrop.show {
            opacity: 0.5 !important;
            z-index: 1050 !important;
        }

        /*  CAROUSEL POSITION INTERFACE STYLES  */
        .carousel-position-container {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            background-color: #f8f9fa;
            max-height: 400px;
            overflow-y: auto;
        }

        .carousel-option {
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }

        .carousel-option:hover {
            background-color: #e9ecef;
        }

        .carousel-option.occupied {
            background-color: #fff5f5;
            border-left: 4px solid #dc3545;
        }

        .carousel-option.available {
            background-color: #f0fff4;
            border-left: 4px solid #28a745;
        }

        .carousel-option .form-check-label {
            width: 100%;
            cursor: pointer;
            font-weight: 500;
        }

        .carousel-option .position-text {
            flex-grow: 1;
            padding-right: 0.5rem;
        }

        .carousel-option small {
            font-size: 0.75rem;
            font-weight: normal;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .carousel-position-container {
                max-height: 300px;
                padding: 0.75rem;
            }

            .carousel-option {
                margin-bottom: 0.5rem;
                padding: 0.375rem;
            }

            .carousel-option .form-check-label {
                font-size: 0.9rem;
            }

            .carousel-option .btn-sm {
                font-size: 0.75rem;
                padding: 0.2rem 0.4rem;
            }

            .position-text {
                word-break: break-word;
            }
        }

        /* Ensure text doesn't overflow */
        .carousel-option .position-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        @media (max-width: 576px) {
            .carousel-option .position-text {
                white-space: normal;
                overflow: visible;
            }
        }

        /*  USER CREATION MODAL STYLING  */

        /* Modal Background and Container */
        #userModal .modal-content {
            border: none;
            border-radius: 1rem;
            box-shadow: 0 20px 50px rgba(102, 126, 234, 0.15);
            background: linear-gradient(145deg, #ffffff 0%, #f0f2ff 100%);
            overflow: hidden;
        }

        #userModal .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom: none;
            padding: 1.5rem 2rem;
            border-radius: 1rem 1rem 0 0;
        }

        #userModal .modal-title {
            font-weight: 600;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
        }

        #userModal .modal-title::before {
            content: "";
            margin-right: 0.5rem;
            font-size: 1.1rem;
        }

        #userModal .btn-close {
            filter: brightness(0) invert(1);
            opacity: 0.8;
        }

        #userModal .btn-close:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        #userModal .modal-body {
            padding: 2rem;
            background: linear-gradient(145deg, #ffffff 0%, #f8f9ff 100%);
        }

        /* Form Styling */
        #userModal .form-label {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        #userModal .form-control,
        #userModal .form-select {
            border: 2px solid #d1d5ff;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
            background-color: #ffffff;
        }

        #userModal .form-control:focus,
        #userModal .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
            background-color: #ffffff;
        }

        #userModal .form-text {
            color: #764ba2;
            font-size: 0.8rem;
            font-style: italic;
        }

        /* Password strength indicator */
        .password-strength {
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }

        .password-strength.weak {
            color: #dc3545;
        }

        .password-strength.medium {
            color: #ffc107;
        }

        .password-strength.strong {
            color: #28a745;
        }

        /* Buttons Styling */
        #userModal .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        #userModal .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        #userModal .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #868e96 100%);
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        #userModal .btn-secondary:hover {
            background: linear-gradient(135deg, #545b62 0%, #6c757d 100%);
            transform: translateY(-2px);
        }

        /* Message Area Styling */
        #userModal .alert {
            border: none;
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            font-weight: 500;
        }

        #userModal .alert-success {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            color: #1b5e20;
            border-left: 4px solid #4caf50;
        }

        #userModal .alert-danger {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            border-left: 4px solid #ffc107;
            border: 1px solid #ffeaa7;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #userModal .modal-body {
                padding: 1.5rem;
            }
        }

        /*  FIX OCCASION SELECT CONTRAST  */
        .form-select option {
            background-color: #ffffff !important;
            color: #212529 !important;
            padding: 8px !important;
        }

        .form-select option:checked,
        .form-select option:hover,
        .form-select option:focus {
            background-color: #0d6efd !important;
            color: #ffffff !important;
            font-weight: 600 !important;
        }

        /* Ensure select text is visible and has good contrast */
        .form-select {
            color: #212529 !important;
            background-color: #ffffff !important;
            border: 2px solid #dee2e6 !important;
            font-weight: 500 !important;
        }

        .form-select:focus {
            border-color: #0d6efd !important;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25) !important;
            color: #212529 !important;
            background-color: #ffffff !important;
        }

        /* Specific fix for selected option visibility */
        .form-select option[selected] {
            background-color: #e7f3ff !important;
            color: #0d6efd !important;
            font-weight: 600 !important;
        }

        /*  PRODUCT MODAL PREMIUM STYLING - VERDE ESMERALDA  */

        /* Modal Background and Container */
        #productModal .modal-content {
            border: none;
            border-radius: 1rem;
            box-shadow: 0 20px 50px rgba(46, 125, 50, 0.15);
            background: linear-gradient(145deg, #ffffff 0%, #e8f5e8 100%);
            overflow: hidden;
        }

        #productModal .modal-header {
            background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);
            color: white;
            border-bottom: none;
            padding: 1.5rem 2rem;
            border-radius: 1rem 1rem 0 0;
        }

        #productModal .modal-title {
            font-weight: 600;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
        }

        #productModal .modal-title::before {
            content: "";
            margin-right: 0.5rem;
            font-size: 1.1rem;
        }

        #productModal .btn-close {
            filter: brightness(0) invert(1);
            opacity: 0.8;
        }

        #productModal .btn-close:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        #productModal .modal-body {
            padding: 2rem;
            background: linear-gradient(145deg, #ffffff 0%, #f1f8e9 100%);
        }

        /* Form Styling */
        #productModal .form-label {
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        #productModal .form-control,
        #productModal .form-select {
            border: 2px solid #c8e6c9;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
            background-color: #ffffff;
        }

        #productModal .form-control:focus,
        #productModal .form-select:focus {
            border-color: #2e7d32;
            box-shadow: 0 0 0 0.2rem rgba(46, 125, 50, 0.15);
            background-color: #ffffff;
        }

        #productModal .form-text {
            color: #4caf50;
            font-size: 0.8rem;
            font-style: italic;
        }

        /*  OCCASIONS CHECKBOXES PREMIUM STYLING  */
        .occasions-checkboxes {
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #c8e6c9;
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            background: linear-gradient(145deg, #ffffff 0%, #f1f8e9 100%);
            box-shadow: inset 0 2px 8px rgba(46, 125, 50, 0.05);
        }

        .occasions-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .occasions-list .form-check {
            margin-bottom: 0;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            background-color: transparent;
        }

        .occasions-list .form-check:hover {
            background-color: rgba(46, 125, 50, 0.05);
            transform: translateX(4px);
        }

        .occasions-list .form-check-input {
            margin-top: 0.25rem;
            border: 2px solid #4caf50;
            border-radius: 0.25rem;
            width: 1.1rem;
            height: 1.1rem;
        }

        .occasions-list .form-check-input:checked {
            background-color: #2e7d32;
            border-color: #2e7d32;
        }

        .occasions-list .form-check-input:focus {
            box-shadow: 0 0 0 0.2rem rgba(46, 125, 50, 0.25);
        }

        .occasions-list .form-check-label {
            font-weight: 500;
            color: #495057;
            cursor: pointer;
            margin-left: 0.5rem;
            line-height: 1.4;
        }

        .occasions-list .form-check-label small {
            font-weight: 400;
            font-style: italic;
            color: #6c757d;
        }

        .occasions-list .form-check-input:checked + .form-check-label {
            color: #2e7d32;
            font-weight: 600;
        }

        /*  CAROUSEL RADIO BUTTONS OPTIMIZATION  */
        .carousel-positions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            padding: 1rem;
            background: linear-gradient(145deg, #ffffff 0%, #f1f8e9 100%);
            border: 2px solid #c8e6c9;
            border-radius: 0.75rem;
            box-shadow: inset 0 2px 8px rgba(46, 125, 50, 0.05);
        }

        .carousel-position {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            background-color: transparent;
            min-height: 2.5rem;
        }

        .carousel-position:hover {
            background-color: rgba(46, 125, 50, 0.05);
            transform: translateY(-1px);
        }

        .carousel-position input[type="radio"] {
            margin-right: 0.75rem;
            border: 2px solid #4caf50;
            width: 1.1rem;
            height: 1.1rem;
        }

        .carousel-position input[type="radio"]:checked {
            background-color: #2e7d32;
            border-color: #2e7d32;
        }

        .carousel-position label {
            font-weight: 500;
            color: #495057;
            cursor: pointer;
            margin: 0;
            line-height: 1.4;
        }

        .carousel-position input[type="radio"]:checked + label {
            color: #2e7d32;
            font-weight: 600;
        }

        /* Buttons Styling */
        #productModal .btn-primary {
            background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        #productModal .btn-primary:hover {
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(46, 125, 50, 0.3);
        }

        #productModal .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #868e96 100%);
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        #productModal .btn-secondary:hover {
            background: linear-gradient(135deg, #545b62 0%, #6c757d 100%);
            transform: translateY(-2px);
        }

        /* Message Area Styling */
        #productModal .alert {
            border: none;
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            font-weight: 500;
        }

        #productModal .alert-success {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            color: #1b5e20;
            border-left: 4px solid #2e7d32;
        }

        #productModal .alert-danger {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            border-left: 4px solid #ffc107;
            border: 1px solid #ffeaa7;
        }

        /* Custom Scrollbar for occasions panel */
        .occasions-checkboxes::-webkit-scrollbar {
            width: 6px;
        }

        .occasions-checkboxes::-webkit-scrollbar-track {
            background: #c8e6c9;
            border-radius: 3px;
        }

        .occasions-checkboxes::-webkit-scrollbar-thumb {
            background: #2e7d32;
            border-radius: 3px;
        }

        .occasions-checkboxes::-webkit-scrollbar-thumb:hover {
            background: #1b5e20;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #productModal .modal-body {
                padding: 1.5rem;
            }

            .carousel-positions {
                grid-template-columns: 1fr;
            }

            .occasions-checkboxes {
                max-height: 150px;
                padding: 0.75rem 1rem;
            }
        }

        /* Force modal to be visible when it has the show class */
        #userModal.modal.show {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 1055 !important;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <div class="mt-2">
                <strong>Cargando panel de administraci贸n...</strong>
            </div>
        </div>
    </div>

    <div class="container-fluid" id="adminPanel">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 px-0 admin-sidebar" id="adminSidebar">
                <div class="sidebar-brand">
                    <h4>
                        <i class="bi bi-shield-check me-2"></i>
                        Admin Panel
                    </h4>
                </div>

                <nav class="sidebar-nav">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#dashboard" data-section="dashboard">
                                <i class="bi bi-speedometer2"></i>
                                Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#products" data-section="products">
                                <i class="bi bi-box-seam"></i>
                                Productos
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#orders" data-section="orders">
                                <i class="bi bi-receipt"></i>
                                Pedidos
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#users" data-section="users">
                                <i class="bi bi-people"></i>
                                Usuarios
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#occasions" data-section="occasions">
                                <i class="bi bi-calendar-event"></i>
                                Ocasiones
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#settings" data-section="settings">
                                <i class="bi bi-gear"></i>
                                Configuraci贸n
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#images" data-section="images">
                                <i class="bi bi-images"></i>
                                Im谩genes
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#logs" data-section="logs">
                                <i class="bi bi-journal-text"></i>
                                Logs
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#schema" data-section="schema">
                                <i class="bi bi-diagram-3"></i>
                                Esquema DB
                            </a>
                        </li>
                        <li class="nav-item mt-3">
                            <a class="nav-link text-warning" href="/" id="backToSite">
                                <i class="bi bi-arrow-left"></i>
                                Volver al sitio
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-danger" href="#" id="logoutBtn">
                                <i class="bi bi-box-arrow-right"></i>
                                Cerrar sesi贸n
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 px-0 admin-content">
                <!-- Header -->
                <header class="admin-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0" id="pageTitle">Dashboard</h5>
                            <small class="text-muted" id="pageSubtitle">Vista general del sistema</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-primary me-3" id="userRole">Administrador</span>
                            <button class="btn btn-outline-secondary btn-sm d-md-none" id="sidebarToggle">
                                <i class="bi bi-list"></i>
                            </button>
                        </div>
                    </div>
                </header>

                <!-- Content Area -->
                <main class="p-4">
                    <!-- Dashboard Section -->
                    <div id="dashboard-section" class="admin-section active">
                        <div class="row mb-4">
                            <div class="col-md-3 mb-3">
                                <div class="card admin-card metric-card">
                                    <div class="card-body text-center">
                                        <i class="bi bi-box-seam display-4 mb-2"></i>
                                        <h3 class="card-title" id="totalProducts">0</h3>
                                        <p class="card-text">Productos</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card admin-card metric-card success">
                                    <div class="card-body text-center">
                                        <i class="bi bi-receipt display-4 mb-2"></i>
                                        <h3 class="card-title" id="totalOrders">0</h3>
                                        <p class="card-text">Pedidos</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card admin-card metric-card warning">
                                    <div class="card-body text-center">
                                        <i class="bi bi-people display-4 mb-2"></i>
                                        <h3 class="card-title" id="totalUsers">0</h3>
                                        <p class="card-text">Usuarios</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card admin-card metric-card info">
                                    <div class="card-body text-center">
                                        <i class="bi bi-graph-up display-4 mb-2"></i>
                                        <h3 class="card-title" id="totalRevenue">$0</h3>
                                        <p class="card-text">Ingresos</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card admin-card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                                            Alertas Recientes
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="alertsList">
                                            <p class="text-muted mb-0">Cargando alertas...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="card admin-card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="bi bi-activity text-success me-2"></i>
                                            Actividad Reciente
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="recentActivity">
                                            <p class="text-muted mb-0">Cargando actividad...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Products Section -->
                    <div id="products-section" class="admin-section" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4>Gesti贸n de Productos</h4>
                            <button class="btn btn-primary btn-admin" id="addProductBtn">
                                <i class="bi bi-plus-circle me-2"></i>
                                Nuevo Producto
                            </button>
                        </div>

                        <div class="card admin-card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="productsTable">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Nombre</th>
                                                <th>Precio</th>
                                                <th>Stock</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="productsTableBody">
                                            <tr>
                                                <td colspan="6" class="text-center text-muted">
                                                    Cargando productos...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Orders Section -->
                    <div id="orders-section" class="admin-section" style="display: none;">
                        <h4>Gesti贸n de Pedidos</h4>
                        <div class="card admin-card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="ordersTable">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Cliente</th>
                                                <th>Total</th>
                                                <th>Estado</th>
                                                <th>Fecha</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ordersTableBody">
                                            <tr>
                                                <td colspan="6" class="text-center text-muted">
                                                    Cargando pedidos...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Users Section -->
                    <div id="users-section" class="admin-section" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4>Gesti贸n de Usuarios</h4>
                            <button class="btn btn-success btn-admin" id="addUserBtn">
                                <i class="bi bi-person-plus me-2"></i>
                                Nuevo Usuario
                            </button>
                        </div>

                        <div class="card admin-card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="usersTable">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Nombre</th>
                                                <th>Email</th>
                                                <th>Rol</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="usersTableBody">
                                            <tr>
                                                <td colspan="6" class="text-center text-muted">
                                                    Cargando usuarios...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Occasions Section -->
                    <div id="occasions-section" class="admin-section" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4>Gesti贸n de Ocasiones</h4>
                            <button class="btn btn-info btn-admin" id="addOccasionBtn">
                                <i class="bi bi-calendar-plus me-2"></i>
                                Nueva Ocasi贸n
                            </button>
                        </div>

                        <div class="card admin-card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="occasionsTable">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Nombre</th>
                                                <th>Tipo</th>
                                                <th>Orden</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="occasionsTableBody">
                                            <tr>
                                                <td colspan="6" class="text-center text-muted">
                                                    Cargando ocasiones...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Section -->
                    <div id="settings-section" class="admin-section" style="display: none;">
                        <h4>Configuraci贸n del Sistema</h4>
                        <div class="card admin-card">
                            <div class="card-body">
                                <p class="text-muted">Configuraci贸n del sistema pr贸ximamente...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Images Section -->
                    <div id="images-section" class="admin-section" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4>Gesti贸n de Im谩genes</h4>
                            <div class="btn-group">
                                <button class="btn btn-primary btn-admin" id="uploadSiteImagesBtn">
                                    <i class="bi bi-cloud-upload me-2"></i>
                                    Subir Im谩genes del Sitio
                                </button>
                                <button class="btn btn-success btn-admin" id="manageProductImagesBtn">
                                    <i class="bi bi-images me-2"></i>
                                    Gestionar Im谩genes de Productos
                                </button>
                            </div>
                        </div>

                        <!-- Site Images Management -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card admin-card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="bi bi-image text-primary me-2"></i>
                                            Imagen Hero
                                        </h6>
                                    </div>
                                    <div class="card-body text-center">
                                        <div id="heroImagePreview" class="mb-3">
                                            <img src="/images/hero-flowers.webp" alt="Hero Image" class="img-fluid rounded shadow-sm" style="max-height: 150px;">
                                        </div>
                                        <button class="btn btn-outline-primary btn-sm" id="changeHeroImageBtn">
                                            <i class="bi bi-pencil me-1"></i>
                                            Cambiar Imagen Hero
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card admin-card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="bi bi-badge-tm text-success me-2"></i>
                                            Logo del Sitio
                                        </h6>
                                    </div>
                                    <div class="card-body text-center">
                                        <div id="logoPreview" class="mb-3">
                                            <img src="/images/logoFloresYa.jpeg" alt="Site Logo" class="img-fluid rounded shadow-sm" style="max-height: 80px;">
                                        </div>
                                        <button class="btn btn-outline-success btn-sm" id="changeLogoBtn">
                                            <i class="bi bi-pencil me-1"></i>
                                            Cambiar Logo
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Product Images Gallery -->
                        <div class="card admin-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="bi bi-grid-3x3-gap text-info me-2"></i>
                                    Galer铆a de Im谩genes de Productos
                                </h6>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary" id="filterAllImages">Todas</button>
                                    <button class="btn btn-outline-secondary" id="filterUnusedImages">Sin usar</button>
                                    <button class="btn btn-outline-secondary" id="filterProductImages">En uso</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="imagesGallery" class="row">
                                    <!-- Images will be loaded here -->
                                    <div class="col-12 text-center text-muted py-5">
                                        <i class="bi bi-images display-1 mb-3"></i>
                                        <p>Cargando galer铆a de im谩genes...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Logs Section -->
                    <div id="logs-section" class="admin-section" style="display: none;">
                        <h4>Logs del Sistema</h4>
                        <div class="card admin-card">
                            <div class="card-body">
                                <p class="text-muted">Sistema de logs pr贸ximamente...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Schema Section -->
                    <div id="schema-section" class="admin-section" style="display: none;">
                        <h4>
                            <i class="bi bi-diagram-3 me-2"></i>
                            Esquema de Base de Datos
                        </h4>

                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-primary" id="loadSchemaInfo">
                                        <i class="bi bi-info-circle me-2"></i>
                                        Ver Estad铆sticas
                                    </button>
                                    <button type="button" class="btn btn-success" id="viewSchemaSQL">
                                        <i class="bi bi-eye me-2"></i>
                                        Ver Esquema
                                    </button>
                                    <button type="button" class="btn btn-warning" id="updateSchemaFile">
                                        <i class="bi bi-arrow-clockwise me-2"></i>
                                        Actualizar Archivo
                                    </button>
                                    <button type="button" class="btn btn-info" id="downloadSchemaSQL">
                                        <i class="bi bi-download me-2"></i>
                                        Descargar SQL
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Schema Stats Card -->
                        <div class="card admin-card mb-4" id="schemaStatsCard" style="display: none;">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-graph-up me-2"></i>
                                    Estad铆sticas del Esquema
                                </h5>
                            </div>
                            <div class="card-body" id="schemaStatsContent">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>

                        <!-- Schema SQL Card -->
                        <div class="card admin-card" id="schemaSQLCard" style="display: none;">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-code-slash me-2"></i>
                                    SQL Schema Completo
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="position-relative">
                                    <button type="button" class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 mt-2 me-2" id="copySchemaSQLBtn">
                                        <i class="bi bi-clipboard"></i>
                                        Copiar
                                    </button>
                                    <pre><code id="schemaSQLContent" class="language-sql" style="max-height: 500px; overflow-y: auto; font-size: 0.85rem; line-height: 1.4;">
<!-- SQL Content will be loaded here -->
                                    </code></pre>
                                </div>
                            </div>
                        </div>

                        <!-- Loading Indicator -->
                        <div class="text-center py-4" id="schemaLoadingIndicator" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2 text-muted">Extrayendo esquema de la base de datos...</p>
                        </div>

                        <!-- Error Alert -->
                        <div class="alert alert-danger" role="alert" id="schemaErrorAlert" style="display: none;">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <span id="schemaErrorMessage">Error al cargar el esquema</span>
                        </div>

                        <!-- Success Alert -->
                        <div class="alert alert-success" role="alert" id="schemaSuccessAlert" style="display: none;">
                            <i class="bi bi-check-circle me-2"></i>
                            <span id="schemaSuccessMessage">Operaci贸n completada exitosamente</span>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Force UI visibility after proper initialization -->
    <script>
        // Better timing for overlay hiding - let initialization complete first
        document.addEventListener("DOMContentLoaded", function() {
            // Wait a bit to allow proper initialization
            setTimeout(() => {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay && overlay.style.display !== 'none') {
                    overlay.style.display = 'none';
                    console.log('[ Admin]  Loading overlay ocultado despu茅s de inicializaci贸n.');

                    // Ensure dashboard is visible
                    const dashboardSection = document.getElementById('dashboard-section');
                    if (dashboardSection) {
                        dashboardSection.style.display = 'block';
                        dashboardSection.classList.add('active');
                        console.log('[ Admin]  Dashboard section forzado a visible');
                    }
                }
            }, 500); // Give 500ms for proper initialization
        });

        //  DIAGNOSTIC FUNCTIONS - Remove in production
        window.testModalDirectly = function() {
            console.log('И Testing modal creation directly...');

            const modalHtml = `
                <div class="modal fade" id="testModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Test Modal</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>Este es un modal de prueba creado directamente.</p>
                                <form id="testForm">
                                    <div class="mb-3">
                                        <label for="testName" class="form-label">Nombre</label>
                                        <input type="text" class="form-control" id="testName" required>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-primary" id="testSaveBtn">Guardar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing test modal
            const existing = document.getElementById('testModal');
            if (existing) existing.remove();

            // Add to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Try to show with Bootstrap
            const modalElement = document.getElementById('testModal');
            if (modalElement && window.bootstrap && window.bootstrap.Modal) {
                const Modal = window.bootstrap.Modal;
                const modal = new Modal(modalElement);
                modal.show();
                console.log(' Test modal shown with Bootstrap');
            } else {
                // Fallback without Bootstrap
                if (modalElement) {
                    modalElement.style.display = 'block';
                    modalElement.style.position = 'fixed';
                    modalElement.style.top = '0';
                    modalElement.style.left = '0';
                    modalElement.style.width = '100%';
                    modalElement.style.height = '100%';
                    modalElement.style.backgroundColor = 'rgba(0,0,0,0.5)';
                    modalElement.style.zIndex = '9999';
                    console.log(' Test modal shown with fallback');
                }
            }
        };

        window.forceShowProductsSection = function() {
            console.log(' Forzando mostrar secci贸n de productos...');

            // Hide all sections
            document.querySelectorAll('.admin-section').forEach(sec => {
                sec.style.display = 'none';
                sec.classList.remove('active');
            });

            // Show products section
            const productsSection = document.getElementById('products-section');
            if (productsSection) {
                productsSection.style.display = 'block';
                productsSection.classList.add('active');
                console.log(' Products section forced visible');

                // Update sidebar active state
                document.querySelectorAll('.sidebar-nav .nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                const productsLink = document.querySelector('[data-section="products"]');
                if (productsLink) {
                    productsLink.classList.add('active');
                }
            } else {
                console.log(' Products section not found');
            }
        };

        console.log(' Funciones de diagn贸stico disponibles:');
        console.log('   - testModalDirectly() - Probar modal b谩sico');
        console.log('   - forceShowProductsSection() - Forzar mostrar productos');
        console.log('   - adminPanel.diagnose() - Diagn贸stico completo (despu茅s de carga)');
    </script>

    <!-- Custom Admin JavaScript with Robust Fallback System -->
    <script type="module">
        //  ROBUST ADMIN PANEL INITIALIZATION SYSTEM 
        // This ensures the interface ALWAYS shows, even with errors

        let initializationAttempts = 0;
        const MAX_ATTEMPTS = 3;
        let emergencyFallbackTimer = null;
        const MAX_INIT_TIME = 10000; // 10 seconds max

        // Force show interface after timeout
        const forceShowInterface = () => {
            console.log('[ Admin]  Force showing interface after timeout');
            hideLoadingOverlay();
            showFallbackInterface();
        };

        // Hide loading overlay
        const hideLoadingOverlay = () => {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                console.log('[ Admin]  Loading overlay state BEFORE hiding:', {
                    display: overlay.style.display,
                    visible: overlay.style.display !== 'none',
                    computed: window.getComputedStyle(overlay).display
                });

                overlay.style.display = 'none';

                console.log('[ Admin]  Loading overlay state AFTER hiding:', {
                    display: overlay.style.display,
                    visible: overlay.style.display !== 'none',
                    computed: window.getComputedStyle(overlay).display
                });

                console.log('[ Admin]  Loading overlay hidden');
            } else {
                console.log('[ Admin] 锔 Loading overlay element not found!');
            }
        };

        // Show fallback interface
        const showFallbackInterface = () => {
            console.log('[ Admin]  Showing fallback interface');

            // Force show main content area
            const mainContent = document.querySelector('.admin-content main');
            if (mainContent) {
                mainContent.classList.add('force-show');
                mainContent.innerHTML = `
                    <div class="container-fluid fallback-mode">
                        <div class="row justify-content-center">
                            <div class="col-md-8 col-lg-6">
                                <div class="card admin-card fallback-alert">
                                    <div class="card-body text-center">
                                        <div class="mb-4">
                                            <i class="bi bi-exclamation-triangle display-1 text-warning"></i>
                                        </div>

                                        <h4 class="alert-heading mb-3">
                                            <i class="bi bi-shield-check me-2"></i>Modo de Recuperaci贸n Activado
                                        </h4>

                                        <p class="text-muted mb-4">
                                            El panel de administraci贸n se carg贸 en modo b谩sico debido a un problema t茅cnico.
                                            Todas las funciones cr铆ticas est谩n disponibles.
                                        </p>

                                        <div class="alert alert-info text-start mb-4">
                                            <h6 class="alert-heading mb-2">
                                                <i class="bi bi-info-circle me-2"></i>Estado del Sistema:
                                            </h6>
                                            <ul class="mb-0">
                                                <li> Interfaz visible y funcional</li>
                                                <li> Navegaci贸n operativa</li>
                                                <li> Autenticaci贸n b谩sica activa</li>
                                                <li>锔 Funciones avanzadas limitadas</li>
                                            </ul>
                                        </div>

                                        <div class="mb-4">
                                            <h6>驴Qu茅 puedes hacer?</h6>
                                            <ul class="text-start">
                                                <li>Refresca la p谩gina (F5) para intentar recargar completamente</li>
                                                <li>Verifica tu conexi贸n a internet</li>
                                                <li>Las funciones b谩sicas siguen disponibles</li>
                                                <li>Contacta al administrador si el problema persiste</li>
                                            </ul>
                                        </div>

                                        <div class="d-flex gap-2 justify-content-center">
                                            <button onclick="location.reload()" class="btn fallback-retry-btn">
                                                <i class="bi bi-arrow-clockwise me-2"></i>Recargar P谩gina
                                            </button>
                                            <button onclick="window.history.back()" class="btn btn-outline-secondary">
                                                <i class="bi bi-arrow-left me-2"></i>Volver Atr谩s
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                console.log('[ Admin]  Fallback interface displayed');
            }

            // Ensure sidebar is visible
            const sidebar = document.getElementById('adminSidebar');
            if (sidebar) {
                sidebar.classList.add('emergency-visible');
            }
        };

        // Main initialization function with error handling
        async function initializeAdminPanel() {
            console.log('[ Admin]  Starting robust initialization...');

            // Set timeout to force show interface
            const timeoutId = setTimeout(forceShowInterface, MAX_INIT_TIME);

            try {
                initializationAttempts++;
                console.log(`[ Admin]  Attempt ${initializationAttempts}/${MAX_ATTEMPTS}`);

                // Dynamic import with error handling - COMPILED JavaScript FILE
                const module = await import('/dist/src/frontend/admin.js');
                console.log('[ Admin]  Module loaded successfully');

                const AdminPanel = module.AdminPanel;
                const adminPanel = new AdminPanel();

                console.log('[ Admin]  Initializing admin panel...');
                await adminPanel.init();

                // Success - clear timeout and hide overlay
                clearTimeout(timeoutId);
                hideLoadingOverlay();
                console.log('[ Admin]  Admin panel initialized successfully!');

                // CRITICAL: Cancel emergency fallback timer since initialization succeeded
                if (emergencyFallbackTimer) {
                    clearTimeout(emergencyFallbackTimer);
                    emergencyFallbackTimer = null;
                    console.log('[ Admin]  Emergency fallback timer canceled - initialization successful');
                }

            } catch (error) {
                console.error(`[ Admin]  Attempt ${initializationAttempts} failed:`, error);

                // Clear timeout for this attempt
                clearTimeout(timeoutId);

                // If we haven't exceeded max attempts, try again
                if (initializationAttempts < MAX_ATTEMPTS) {
                    console.log(`[ Admin]  Retrying in 2 seconds... (${initializationAttempts}/${MAX_ATTEMPTS})`);
                    setTimeout(initializeAdminPanel, 2000);
                } else {
                    // Max attempts reached - show fallback
                    console.log('[ Admin]  Max attempts reached, showing fallback interface');
                    hideLoadingOverlay();
                    showFallbackInterface();
                }
            }
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('[ Admin]  DOM loaded, starting initialization');
                initializeAdminPanel();
            });
        } else {
            console.log('[ Admin]  DOM already loaded, starting initialization');
            initializeAdminPanel();
        }

        // Emergency fallback - show interface after 15 seconds no matter what
        console.log('[ Admin]  Setting emergency fallback timer for 15 seconds');
        emergencyFallbackTimer = setTimeout(() => {
            console.log('[ Admin]  Emergency fallback triggered - 15 seconds elapsed');

            // Add detailed diagnostic before triggering fallback
            const currentState = {
                initializationAttempts,
                adminPanelExists: !!window.adminPanel,
                adminPanelVisible: window.adminPanel && typeof window.adminPanel.isVisible === 'function' ? window.adminPanel.isVisible() : 'unknown',
                loadingOverlayState: document.getElementById('loadingOverlay')?.style.display,
                loadingOverlayVisible: document.getElementById('loadingOverlay')?.style.display !== 'none',
                mainContentExists: !!document.getElementById('main-content'),
                mainContentVisible: document.getElementById('main-content')?.style.display !== 'none',
                dashboardExists: !!document.getElementById('dashboard-section'),
                dashboardVisible: document.getElementById('dashboard-section')?.style.display !== 'none',
                mainContentInnerHTML: document.querySelector('.admin-content main')?.innerHTML?.length || 0
            };

            console.log('[ Admin]  Critical state at emergency fallback trigger:', currentState);

            hideLoadingOverlay();
            const mainContent = document.querySelector('.admin-content main');
            console.log('[ Admin]  Main content check for fallback:', {
                exists: !!mainContent,
                innerHTML: mainContent?.innerHTML?.trim() || '',
                shouldShowFallback: mainContent && mainContent.innerHTML.trim() === ''
            });

            if (mainContent && mainContent.innerHTML.trim() === '') {
                console.log('[ Admin]  Showing fallback interface - main content is empty');
                showFallbackInterface();
            } else {
                console.log('[ Admin]  Main content exists, NOT showing fallback interface');
            }
        }, 15000);

        console.log('[ Admin]  Emergency fallback timer ID:', emergencyFallbackTimer);

        //  ADVANCED DIAGNOSTIC FUNCTIONS 

        // Check if the admin.js module is accessible
        window.checkAdminModule = async function() {
            console.log(' === DIAGNSTICO DE MDULO ADMIN ===');

            try {
                console.log(' Intentando cargar m贸dulo admin.js...');
                const startTime = Date.now();

                const module = await import('/dist/src/frontend/admin.js');
                const loadTime = Date.now() - startTime;

                console.log(` M贸dulo cargado exitosamente en ${loadTime}ms`);
                console.log(' Contenido del m贸dulo:', module);

                if (module.AdminPanel) {
                    console.log(' AdminPanel class encontrada');
                    const testInstance = new module.AdminPanel();
                    console.log(' Instancia de AdminPanel creada:', testInstance);
                } else {
                    console.log(' AdminPanel class NO encontrada en el m贸dulo');
                }

            } catch (error) {
                console.log(' Error cargando m贸dulo admin.js:', error);
                console.log(' Detalles del error:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
            }

            console.log('=====================================');
        };

        // Force show basic interface (bypass all JavaScript)
        window.forceShowInterface = function() {
            console.log(' FORZANDO MUESTRA DE INTERFAZ BSICA');

            // Hide loading overlay
            hideLoadingOverlay();

            // Show basic interface
            const mainContent = document.querySelector('.admin-content main');
            if (mainContent) {
                mainContent.innerHTML = `
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-12">
                                <div class="alert alert-success">
                                    <h4><i class="bi bi-check-circle me-2"></i>Interfaz B谩sica Activada</h4>
                                    <p>Panel de administraci贸n cargado en modo b谩sico de emergencia.</p>
                                    <hr>
                                    <p><strong>Funciones disponibles:</strong></p>
                                    <ul>
                                        <li> Navegaci贸n visible</li>
                                        <li> Logout funcional</li>
                                        <li> Volver al sitio</li>
                                        <li>锔 Funciones avanzadas deshabilitadas</li>
                                    </ul>
                                </div>

                                <div class="row mt-4">
                                    <div class="col-md-4 mb-3">
                                        <div class="card admin-card">
                                            <div class="card-body text-center">
                                                <i class="bi bi-house-door display-4 text-primary mb-3"></i>
                                                <h5>Dashboard</h5>
                                                <p class="text-muted">Vista general (modo b谩sico)</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <div class="card admin-card">
                                            <div class="card-body text-center">
                                                <i class="bi bi-box-seam display-4 text-success mb-3"></i>
                                                <h5>Productos</h5>
                                                <p class="text-muted">Pr贸ximamente</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <div class="card admin-card">
                                            <div class="card-body text-center">
                                                <i class="bi bi-people display-4 text-info mb-3"></i>
                                                <h5>Usuarios</h5>
                                                <p class="text-muted">Pr贸ximamente</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                mainContent.classList.add('emergency-visible');
            }

            console.log(' Interfaz b谩sica mostrada exitosamente');
        };

        // Auto-diagnostic on load
        setTimeout(() => {
            const hasContent = document.querySelector('.admin-content main')?.innerHTML.trim();
            if (!hasContent || hasContent === '') {
                console.log('锔 No se detect贸 contenido en el panel, ejecutando diagn贸stico autom谩tico...');
                window.checkAdminModule();
            }
        }, 3000);

        //  SYSTEM HEALTH CHECK 
        window.systemHealthCheck = function() {
            console.log(' === VERIFICACIN DE SALUD DEL SISTEMA ===');

            // Enhanced sidebar visibility check
            const sidebar = document.getElementById('adminSidebar');
            const sidebarVisible = sidebar && window.getComputedStyle(sidebar).display !== 'none' && window.getComputedStyle(sidebar).visibility !== 'hidden';

            const checks = {
                'DOM Ready': document.readyState === 'complete',
                'Loading Overlay Hidden': document.getElementById('loadingOverlay')?.style.display === 'none',
                'Main Content': !!document.querySelector('.admin-content main'),
                'Sidebar Element Exists': !!document.getElementById('adminSidebar'),
                'Sidebar Visible': sidebarVisible,
                'Navigation': !!document.querySelector('.sidebar-nav'),
                'CSS Loaded': !!document.styleSheets.length,
                'JavaScript Loaded': typeof window !== 'undefined',
                'Console Available': typeof console !== 'undefined'
            };

            let allPassed = true;
            for (const [check, passed] of Object.entries(checks)) {
                const status = passed ? '' : '';
                console.log(`${status} ${check}: ${passed}`);
                if (!passed) allPassed = false;
            }

            console.log(`\n Estado General: ${allPassed ? ' SISTEMA SALUDABLE' : ' PROBLEMAS DETECTADOS'}`);

            if (!allPassed) {
                console.log('\n RECOMENDACIONES:');
                console.log('1. Verifica la conexi贸n a internet');
                console.log('2. Recarga la p谩gina (F5)');
                console.log('3. Limpia la cach茅 del navegador');
                console.log('4. Ejecuta: forceShowInterface() para activar modo b谩sico');
            }

            console.log('=====================================');
            return allPassed;
        };

        // Auto health check
        setTimeout(() => {
            console.log(' Ejecutando verificaci贸n autom谩tica de salud del sistema...');
            window.systemHealthCheck();
        }, 1000);

        // 锟 DIAGNOSTIC FUNCTION - Run this in browser console
        window.checkAuthStatus = function() {
            console.log(' === DIAGNSTICO DE AUTENTICACIN ===');

            const userData = localStorage.getItem('floresya_user');
            const sessionTime = localStorage.getItem('floresya_session');

            console.log(' Estado de localStorage:');
            console.log('  - Usuario:', userData ? ' Presente' : ' Ausente');
            console.log('  - Sesi贸n:', sessionTime ? ' Presente' : ' Ausente');

            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    console.log(' Datos del usuario:');
                    console.log('  - Email:', user.email);
                    console.log('  - Nombre:', user.full_name || user.name || 'N/A');
                    console.log('  - Rol:', user.role);
                    console.log('  - Activo:', user.is_active);

                    if (user.role !== 'admin') {
                        console.log(' PROBLEMA: El usuario no tiene rol de administrador');
                        console.log(' SOLUCIN: Inicia sesi贸n con admin@floresya.com / admin');
                    } else {
                        console.log(' El usuario tiene rol de administrador');
                    }
                } catch (e) {
                    console.log(' Error parseando datos del usuario:', e);
                }
            }

            if (sessionTime) {
                const sessionAge = Date.now() - parseInt(sessionTime);
                const hoursOld = Math.floor(sessionAge / (1000 * 60 * 60));
                console.log(' Edad de la sesi贸n:', hoursOld, 'horas');

                if (sessionAge > 24 * 60 * 60 * 1000) {
                    console.log(' PROBLEMA: La sesi贸n ha expirado (m谩s de 24 horas)');
                    console.log(' SOLUCIN: Inicia sesi贸n nuevamente');
                } else {
                    console.log(' La sesi贸n est谩 dentro del tiempo v谩lido');
                }
            }

            console.log(' Para acceder como admin:');
            console.log('  1. Ve a la p谩gina principal: http://localhost:3000');
            console.log('  2. Haz click en "Iniciar Sesi贸n"');
            console.log('  3. Usa: admin@floresya.com / admin');
            console.log('  4. O usa el bot贸n r谩pido "Admin" en el modal de login');

            console.log('=====================================');
        };

        // Auto-run diagnostic if no user data found
        setTimeout(() => {
            const userData = localStorage.getItem('floresya_user');
            if (!userData) {
                console.log('癸 No se encontraron datos de usuario. Ejecuta checkAuthStatus() para diagn贸stico.');
            }
        }, 1000);

        //  MODAL DIAGNOSTIC FUNCTION 
        window.testBootstrapModal = function() {
            console.log('И === TESTING BOOTSTRAP MODAL DIRECTLY ===');

            // Create a simple test modal
            const testModalHtml = `
                <div class="modal fade" id="testBootstrapModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-warning">
                                <h5 class="modal-title">И Test Bootstrap Modal</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p><strong>隆Modal de prueba funcionando!</strong></p>
                                <p>Si puedes ver esto, Bootstrap Modal est谩 funcionando correctamente.</p>
                                <div class="alert alert-info">
                                    <small>Timestamp: ${new Date().toISOString()}</small>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                <button type="button" class="btn btn-warning" onclick="alert('Bot贸n de prueba funcionando')">Test Button</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing test modal
            const existing = document.getElementById('testBootstrapModal');
            if (existing) {
                existing.remove();
                console.log('锔 Removed existing test modal');
            }

            // Add to body
            document.body.insertAdjacentHTML('beforeend', testModalHtml);
            console.log(' Test modal HTML added to body');

            // Try Bootstrap Modal
            const modalElement = document.getElementById('testBootstrapModal');
            if (modalElement && window.bootstrap && window.bootstrap.Modal) {
                try {
                    const modal = new window.bootstrap.Modal(modalElement, {
                        backdrop: true,
                        keyboard: true,
                        focus: true
                    });

                    console.log(' Bootstrap Modal instance created');

                    modal.show();
                    console.log(' modal.show() called');

                    // FORCE MODAL VISIBILITY - Critical fix
                    setTimeout(() => {
                        const modalToFix = document.getElementById('testBootstrapModal');
                        if (modalToFix) {
                            modalToFix.style.visibility = 'visible';
                            modalToFix.style.opacity = '1';
                            modalToFix.style.display = 'block';
                            modalToFix.classList.add('show');
                            console.log(' FORCED test modal visibility');
                        }
                    }, 50);

                    // Check state after show
                    setTimeout(() => {
                        const style = window.getComputedStyle(modalElement);
                        console.log(' Modal state after show:', {
                            display: style.display,
                            visibility: style.visibility,
                            opacity: style.opacity,
                            zIndex: style.zIndex,
                            position: style.position,
                            top: style.top,
                            left: style.left,
                            transform: style.transform
                        });

                        console.log(' Modal classes:', modalElement.className);

                        const backdrop = document.querySelector('.modal-backdrop');
                        if (backdrop) {
                            const backdropStyle = window.getComputedStyle(backdrop);
                            console.log(' Backdrop found:', {
                                display: backdropStyle.display,
                                zIndex: backdropStyle.zIndex,
                                opacity: backdropStyle.opacity
                            });
                        } else {
                            console.log(' No backdrop found');
                        }
                    }, 300);

                } catch (error) {
                    console.error(' Error with Bootstrap Modal:', error);
                }
            } else {
                console.log(' Bootstrap Modal not available');
                console.log('Bootstrap available:', !!window.bootstrap);
                console.log('Modal class available:', !!(window.bootstrap && window.bootstrap.Modal));
            }

            console.log('======================================');
        };

        //  CAROUSEL PRODUCT DETAILS FUNCTION 
        window.showCarouselProductDetails = function(productId, productName, productSummary, position) {
            console.log(' Showing product details:', { productId, productName, productSummary, position });

            // Create modal HTML
            const detailsModalHtml = `
                <div class="modal fade" id="carouselProductDetailsModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-info text-white">
                                <h5 class="modal-title"> Producto en Carousel</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold"> Nombre del Producto:</label>
                                    <p class="border p-2 bg-light rounded">${productName}</p>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold"> Posici贸n en Carousel:</label>
                                    <p class="border p-2 bg-light rounded">Posici贸n ${position}</p>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold"> Resumen:</label>
                                    <p class="border p-2 bg-light rounded" style="max-height: 150px; overflow-y: auto;">
                                        ${productSummary || 'Sin resumen disponible'}
                                    </p>
                                </div>

                                <div class="alert alert-info">
                                    <small>
                                         <strong>Tip:</strong> Para cambiar este producto, selecciona su posici贸n en el formulario principal.
                                    </small>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('carouselProductDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', detailsModalHtml);

            // Show modal
            const modalElement = document.getElementById('carouselProductDetailsModal');
            if (modalElement && window.bootstrap && window.bootstrap.Modal) {
                try {
                    const modal = new window.bootstrap.Modal(modalElement);
                    modal.show();

                    // Force visibility (same fix as product modal)
                    setTimeout(() => {
                        if (modalElement) {
                            modalElement.style.visibility = 'visible';
                            modalElement.style.opacity = '1';
                            modalElement.style.display = 'block';
                            modalElement.classList.add('show');
                        }
                    }, 50);

                    console.log(' Product details modal shown');
                } catch (error) {
                    console.error(' Error showing product details modal:', error);
                }
            } else {
                console.log(' Bootstrap Modal not available for details');
            }
        };

        //  SIDEBAR SPECIFIC DIAGNOSTIC FUNCTION 
        window.diagnoseSidebar = function() {
            console.log(' === DIAGNSTICO ESPECFICO DEL SIDEBAR ===');

            const sidebar = document.getElementById('adminSidebar');
            if (!sidebar) {
                console.log(' CRTICO: Elemento adminSidebar NO encontrado en el DOM');
                return false;
            }

            console.log(' Elemento adminSidebar encontrado');

            // Check all visibility properties
            const computedStyle = window.getComputedStyle(sidebar);
            const inlineStyle = sidebar.style;

            console.log(' Propiedades de visibilidad:');
            console.log('  - display (computed):', computedStyle.display);
            console.log('  - display (inline):', inlineStyle.display);
            console.log('  - visibility (computed):', computedStyle.visibility);
            console.log('  - visibility (inline):', inlineStyle.visibility);
            console.log('  - opacity (computed):', computedStyle.opacity);
            console.log('  - opacity (inline):', inlineStyle.opacity);

            console.log(' Propiedades de posicionamiento:');
            console.log('  - position (computed):', computedStyle.position);
            console.log('  - position (inline):', inlineStyle.position);
            console.log('  - width (computed):', computedStyle.width);
            console.log('  - width (inline):', inlineStyle.width);
            console.log('  - min-height (computed):', computedStyle.minHeight);
            console.log('  - min-height (inline):', inlineStyle.minHeight);

            console.log(' Clases CSS aplicadas:', sidebar.className);

            // Check for conflicting CSS rules
            const conflictingRules = [];
            if (computedStyle.display === 'none') conflictingRules.push('display: none');
            if (computedStyle.visibility === 'hidden') conflictingRules.push('visibility: hidden');
            if (computedStyle.opacity === '0') conflictingRules.push('opacity: 0');
            if (computedStyle.width === '0px') conflictingRules.push('width: 0px');

            if (conflictingRules.length > 0) {
                console.log('锔 REGLAS CSS CONFLICTIVAS ENCONTRADAS:', conflictingRules);
            } else {
                console.log(' No se encontraron reglas CSS conflictivas');
            }

            // Check parent containers
            const parent = sidebar.parentElement;
            if (parent) {
                const parentStyle = window.getComputedStyle(parent);
                console.log('ㄢ┾р Contenedor padre:');
                console.log('  - Elemento padre:', parent.tagName + (parent.id ? '#' + parent.id : '') + (parent.className ? '.' + parent.className.split(' ').join('.') : ''));
                console.log('  - Display padre:', parentStyle.display);
                console.log('  - Overflow padre:', parentStyle.overflow);
            }

            // Check if sidebar content is loaded
            const nav = sidebar.querySelector('.sidebar-nav');
            const navItems = sidebar.querySelectorAll('.nav-link');

            console.log(' Contenido del sidebar:');
            console.log('  - Navegaci贸n encontrada:', !!nav);
            console.log('  - Items de navegaci贸n:', navItems.length);

            // Final assessment
            const isVisible = computedStyle.display !== 'none' &&
                            computedStyle.visibility !== 'hidden' &&
                            computedStyle.opacity !== '0' &&
                            computedStyle.width !== '0px';

            console.log(` RESULTADO FINAL: ${isVisible ? ' SIDEBAR VISIBLE' : ' SIDEBAR OCULTO'}`);

            if (!isVisible) {
                console.log(' POSIBLES SOLUCIONES:');
                console.log('1. Ejecuta: document.getElementById("adminSidebar").style.display = "block"');
                console.log('2. Ejecuta: document.getElementById("adminSidebar").classList.add("emergency-visible")');
                console.log('3. Verifica que no haya CSS que oculte .admin-sidebar');
                console.log('4. Recarga la p谩gina completamente (Ctrl+F5)');
            }

            console.log('=====================================');
            return isVisible;
        };

        // Auto-run sidebar diagnostic after initialization
        setTimeout(() => {
            console.log(' Ejecutando diagn贸stico autom谩tico del sidebar...');
            window.diagnoseSidebar();
        }, 2000);
    </script>

    <!-- User Creation Modal -->
    <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalLabel">Crear Nuevo Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Message Area -->
                    <div id="userMessageArea" class="alert-container mb-3" style="display: none;">
                        <div id="userMessage" class="alert" role="alert"></div>
                    </div>

                    <form id="userForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="userEmail" class="form-label">Email *</label>
                                    <input type="email" class="form-control" id="userEmail" required
                                           placeholder="usuario@ejemplo.com">
                                    <div class="form-text">Email 煤nico para el usuario</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="userFullName" class="form-label">Nombre Completo *</label>
                                    <input type="text" class="form-control" id="userFullName" required
                                           placeholder="Juan P茅rez">
                                    <div class="form-text">Nombre completo del usuario</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="userPassword" class="form-label">Contrase帽a *</label>
                                    <input type="password" class="form-control" id="userPassword" required
                                           placeholder="M铆nimo 8 caracteres">
                                    <div class="form-text">Debe contener may煤scula, min煤scula y n煤mero</div>
                                    <div id="passwordStrength" class="password-strength" style="display: none;"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="userPhone" class="form-label">Tel茅fono</label>
                                    <input type="tel" class="form-control" id="userPhone"
                                           placeholder="+58 412 123 4567">
                                    <div class="form-text">Opcional, formato internacional</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="userRole" class="form-label">Rol *</label>
                                    <select class="form-select" id="userRole" required>
                                        <option value="">Seleccionar rol...</option>
                                        <option value="user">Usuario</option>
                                        <option value="admin">Administrador</option>
                                        <option value="support">Soporte</option>
                                    </select>
                                    <div class="form-text">Nivel de acceso del usuario</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="userIsActive" checked>
                                    <label class="form-check-label" for="userIsActive">
                                        Usuario activo
                                    </label>
                                    <div class="form-text">Puede iniciar sesi贸n</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="userEmailVerified">
                                    <label class="form-check-label" for="userEmailVerified">
                                        Email verificado
                                    </label>
                                    <div class="form-text">Email confirmado</div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveUserBtn">Crear Usuario</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>